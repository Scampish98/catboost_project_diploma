# Морфологический разбор текстов на дореволюционном русском языке методом машинного обучения с помощью Catboost

## Модели

**Параметры моделей**:
  * само слово
  * несколько слов перед ним в предложении (количество указывается в конфигурационном файле)
  * несколько слов после него в предложении (количество указывается в конфигурационном файле)
  * начальная форма слова
  * уже вычисленные атрибуты (опционально, указывается в конфигурационном файле) 


Для каждого атрибута будет обучена своя Catboost модель. 

### Метод последовательного обучения атрибутов 
#### Модель с обучением атрибутов в "прямом" порядке или модель версии 0
**Файл**: `src/lib/models/sequential_learning_model.py`

**Класс**: `SequentialLearningModel`

Обучение Catboost моделей производится по возрастанию номеров атрибутов (идентификаторы в БД).

#### Модель с обучением атрибутов в "обратном" порядке или модель версии 2
**Файл**: `src/lib/models/sequential_learning_model.py`

**Класс**: `ReversedSequentialLearningModel`


То же, что и модель версии 0, только атрибуты рассматриваем в порядке убывания номеров.

### Метод обучения атрибутов с учетом дерева атрибутов
#### Модель с обучением атрибутов в порядке обхода в глубину дерева атрибутов или модель версии 1

**Файл**: `src/lib/models/sequential_learning_based_on_attribute_tree_model.py`

**Класс**: `SequentialLearningBasedOnAttributeTreeModel`

Эта модель использует дерево атрибутов. 
Сначала обучаем для первого атрибута (часть речи).
Затем дробим данные на группы по разным значениям 
рассмотренного атрибута.
Для каждой группы обучаем модель для нового атрибута 
(и так далее в рекурсии).
Т.е. обучение Catboost моделей атрибутов происходит в порядке
обхода в глубину дерева атрибутов.

## Конфигурационный файл

```yaml
catboost_params:                 # Параметры для catboost (описаны тут https://catboost.ai/docs)
  iterations: 100                # Количество итераций для обучения модели
  learning_rate: 0.1             # Скорость обучения модели
  loss_function: MultiClass      # Функция потерь
  task_type: CPU                 # На чем запускать (CPU/GPU). На GPU точность моделей сильно проседает.
model_version: 0                 # Версия модели (0, 1, 2). Описание выше.
number_words_after: 5            # Сколько слов в предложении перед рассматриваемым использовать в качестве параметров (0-5)
number_words_before: 5           # Сколько слов в предложении после рассматриваемого использовать в качестве параметров (0-5)
refit_model: false               # Переобучить модель (по-умолчанию продолжает с момента, на котором обучение было остановленно)
logging_level: stats             # Уровень логирования (silent: ничего, debug: python, catboost - debug, info: python, catboost - info, stats: python - info, catboost - verbose, error: python - error, catboost - silent)
smart_split: true                # Разбиение данных на обучающую и тестовую выборки (для каждого атрибута независимо): для каждого возможного значения атрибута должны быть примеры и в обучающей (примерно 1/3) и в тестовой (примерно 2/3) выборках.
use_calculated_parameters: true  # Все предыдущие рассмотренные атрибуты участвуют в дальнейшем обучении как параметры.
use_initial_form: true           # Начальная форма является параметром для обучения.
use_true_initial_form: true      # Использовать ли настоящую начальную форму в предсказании или пользоваться леммером (для статистики).
lemmer_type: smalt_stemmer       # Способ получения начальной формы слова: empty - выдавать пустую строку в качестве начальной формы, smalt_stemmer - стеммер, перенесенный из `Stemmer_RU.php`
excluded_attributes:             # Часть атрибутов можно исключить из выборки (104-109 из старого дерева атрибутов)
  - 105
  - 106
  - 107
  - 108
  - 109
  - 110
excluded_attribute_values:       # Слова, у которых среди значений атрибутов есть значения из списка, исключаются из обучения (369-400 из старого дерева атрибутов).
  - 370
  - 371
  - 372
  - 373
  - 374
  - 375
  - 376
  - 377
  - 378
  - 379
  - 380
  - 381
  - 382
  - 383
  - 384
  - 385
  - 386
  - 387
  - 388
  - 389
  - 390
  - 391
  - 392
  - 393
  - 394
  - 395
  - 396
  - 397
  - 398
  - 399
  - 400
  - 401
```

## Формат данных

Структура `tsv` файлов должна быть следующая:
  1. В первой строке должны содержаться имена столбцов данных
  2. Каждая из следующих строк содержит одну строку данных

### Пример
```text
WORD            1   ... 110 word_-1 word_1  initial_form    ...
сочувствiемъ    1   ... 0   общимъ  къ      сочувствiе      ...
...             ... ... ... ...     ...     ...             ...
```

## Запуск

Все файлы для запуска лежат в корне `src/`.

### Обучение модели
**Файл**: `src/train.py`

**Параметры командной строки**:
  * `-c` (`--config`): путь до конфигурационного файла
  * `-m` (`--meta`): путь до файла meta.json (файл с данными о моделях)
  * `-t` (`--train-data`): путь до файла с данными для обучения
  * `-v` (`--validation-data`): путь до файла с валидационными данными 
    (опционально, используется только с опцией smart_split: false в конфигурационном файле)

**Пример запуска**:
```shell
$ python3 train.py -c ../config/config.yaml -m ../data/meta.json -t ../data/catboost_data.tsv
```

После окончания обучения в папке `models/` появится новая папка, содержащая файлы `.bin` для каждой 
CatBoost модели и файл config.yaml (конфигурационный файл для этой модели). В meta.json появится новая 
запись с данными обученной модели.

### Обработка текста
**Файл**: `src/process.py`

**Параметры командной строки**:
  * `-c` (`--config`): путь до конфигурационного файла
  * `-m` (`--meta`): путь до файла meta.json (файл с данными о моделях)
  * `--input`: путь до файла с текстом для разбора
  * `--output`: путь до файла с результатом разбора (результат будет в формате json)

**Пример запуска**
```shell
$ python3 process.py -c ../config/config.yaml -m ../data/meta.json --input ../text.txt --output ../result.json
```

**Пример результата разбора**:
```json
[
  {
    "word": "прошедшiй",
    "word_id": "0",
    "sentence_id": "0",
    "paragraph_id": "0",
    "initial_form": "прошедшi",
    "result": {
      "Часть речи": "Прилагательное",
      "Аттрибуты": {
        "Разряд по значению": "Качественное",
        "По форме": "Полное",
        "Аттрибуты": {
          "Способ образования форм степеней сравнения": "Синтетический"
        },
        "Степень сравнения": "Сравнительная",
        "Категория числа (зависимая)": "Единственное",
        "Категория рода (зависимая)": "Мужской"
      }
    }
  },
  {
    "word": "годъ",
    "word_id": "1",
    "sentence_id": "0",
    "paragraph_id": "0",
    "initial_form": "год",
    "result": {
      "Часть речи": "Cуществительное",
      "Аттрибуты": {
        "Разряд по значению(А)": "Неодушевленное",
        "Разряд по значению(Б)": "Нарицательное",
        "Разряд по значению(В)": "Конкретное",
        "Категория рода": "Мужской",
        "Категория числа": "Единственное",
        "Категория падежа": "Винительный",
        "Типы склонения": "II склонение"
      }
    }
  },
  {
    "word": "былъ",
    "word_id": "2",
    "sentence_id": "0",
    "paragraph_id": "0",
    "initial_form": "был",
    "result": {
      "Часть речи": "Глагол",
      "Аттрибуты": {
        "Отвлеченный глагол-связка": "Да"
      }
    }
  },
  {
    "word": "замѣчателенъ",
    "word_id": "3",
    "sentence_id": "0",
    "paragraph_id": "0",
    "initial_form": "замѣчател",
    "result": {
      "Часть речи": "Прилагательное",
      "Аттрибуты": {
        "Разряд по значению": "Качественное",
        "По форме": "Полное",
        "Аттрибуты": {
          "Способ образования форм степеней сравнения": "Синтетический"
        },
        "Степень сравнения": "Сравнительная",
        "Категория числа (зависимая)": "Единственное",
        "Категория рода (зависимая)": "Мужской"
      }
    }
  }
]
```

### Предсказание на подготовленных данных
**Файл**: `src/predict.py`

**Параметры командной строки**:
  * `-c` (`--config`): путь до конфигурационного файла
  * `-m` (`--meta`): путь до файла meta.json (файл с данными о моделях)
  * `--input`: путь до файла с данными для разбора (должны быть обработаны и храниться в формате tsv)
  * `--output-directory`: директория для файла с результатом разбора (по умолчанию, `models/{model_id}`)
  * `--output-filename`: имя файла с результатом разбора (по умолчанию, `predict.tsv`)

Если в тексте (во входных данных) некоторых слов для параметров нет (например, перед этим словом в предложении меньше пяти слов),
эти слова заменяются 0.

**Пример запуска**
```shell
$ python3 predict.py -c ../config/config.yaml -m ../data/meta.json --input ../data/catboost_data.tsv
```

**Пример входных данных**
```text
WORD	word_-5	word_-4	word_-3	word_-2	word_-1	word_1	word_2	word_3	word_4	word_5	initial_form	word_id	sentence_id	paragraph_id
общимъ	0   Мы	начали	нашу	статью	сочувствіемъ	къ	Н	И	Пирогову	общій	5	1	2
сочувствіемъ	Мы	начали	нашу	статью	общимъ	къ	Н	И	Пирогову	возбужденнымъ	сочувствіе	6	1	2
```

**Пример выходных данных**
```t
WORD	initial_form	word_-1	word_-2	word_-3	word_-4	word_-5	word_1	word_2	word_3	word_4	word_5	1	2	3	4	5	6	7	8	9	26	27	28	29	30	31	32	33	34	35	36	37	38	40	46	47	48	41	42	43	45	49	53	50	51	52	54	55	59	60	61	39	62	63	64	65	10	11	12	13	14	15	16	17	18	19	97	98	99	66	67	68	69	70	71	72	73	74	75	81	82	83	84	85	86	87	92	94	93	95	96	100	101	102	104	103	88	89	90	20	21	22	23	24	25	76	77	78	79	80	word_id	sentence_id	paragraph_id	44	56	57	58	91	105	106	107	108	109	110
общимъ	общій	статью	нашу	начали	Мы	0	сочувствіемъ	къ	Н	И	Пирогову	39	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	42	47	52	55	66	0	0	67	72	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	5	1	2	0	0	0	0	0	0	0	0	0	0	0
сочувствіемъ	сочувствіе	общимъ	статью	нашу	начали	Мы	къ	Н	И	Пирогову	возбужденнымъ	1	0	4	8	12	19	24	30	33	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	6	1	2	0	0	0	0	0	0	0	0	0	0	0
```

### Оценка результата 
**Файл**: `src/compare.py`

**Параметры командной строки**:
  * `-c` (`--config`): путь до конфигурационного файла
  * `-m` (`--meta`): путь до файла meta.json (файл с данными о моделях)
  * `--result-data-directory`: директория файла с данными для сравнения (по умолчанию, `models/{model_id}`)
  * `--result-data-filename`: имя файла с данными для сравнения (по умолчанию, `predict.tsv`)
  * `--validate-data`: путь до файла с эталонными данными

Файлы с результатом разбора и с эталонными данными должны быть в формате tsv.

**Пример запуска**
```shell
$ python3 compare.py --validate-data ../data/catboost_data.tsv
```
**Пример вывода**
```text
Accuracy assessment
Attribute accuracy assessment
Name = 1, bad = 88882, good = 551300, cnt = 640182, bad percent = 13.883864276096485, good percent = 86.11613572390351
...
Name = 109, bad = 507, good = 388, cnt = 895, bad percent = 56.64804469273743, good percent = 43.35195530726257
Total bad = 326014, total good = 3490543, total cnt = 3816557, total bad percent = 8.542096973790775, total good percent = 91.45790302620922
Word accuracy assessment
Mean: 83.28631048083096
Median: 100.0
5: 0.0
10: 0.0
25: 100.0
75: 100.0
90: 100.0
95: 100.0
Total words: 640196, total correct part of speech: 551300, total incorrect part
of speech: 88896, error percent: 13.88574748983124, correct percent:
86.11425251016877

========================
Completeness assessment
Mean: 100.0
Median: 100.0
```